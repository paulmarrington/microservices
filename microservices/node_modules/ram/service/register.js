var http = require("http");
var url_parser = require("url").parse;

const header = { "Content-Type": "application/json" };
const service_register = process.env.RAM_MICROSERVICE_REGISTER_PORT_80_TCP_ADDR;

module.exports = {
  register: (services) => {
    http.createServer((request, response) => {
      var body = [], reply = {};
      request.on("data", (data) => {
        body.push(data)
      });
      request.on("end", () => {
        var packet = body.join("");
        response.writeHead(200, header);
        var send = (answer) => {
          if (answer.error) {
            answer.url =     request.url;
            answer.packet = packet
          }
          response.end(JSON.stringify(answer))
        };
        try {
          packet = JSON.parse(packet);
          var url = url_parser(request.url, true);
          for (var key in request.query) {
            if (!packet[key]) packet[key] = request.query[key]
          }
          var action =  packet.action || url.pathname.slice(1);
          if (!services[action]) {
            return send({error: `Action ${action} not recognised`});
          }
          reply = services[action](packet);
          response.end(JSON.stringify(reply))
        } catch (err) {
          send({error: err.toString()})
        }
      })
    }).listen(80)
  }
};